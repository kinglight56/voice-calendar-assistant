<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è¯­éŸ³é©±åŠ¨çš„ Google æ—¥ç¨‹åŠ©æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --card-bg: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.2);
      --danger: #f97373;
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 960px;
      padding: 32px 20px;
    }

    h1 {
      margin: 0 0 24px;
      font-size: 32px;
      letter-spacing: 1px;
      text-shadow: 0 0 16px rgba(34, 197, 94, 0.4);
    }

    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border-radius: 20px;
      padding: 20px 20px 24px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(12px);
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-sub);
      margin-bottom: 12px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }
    .status-dot.busy {
      background: #fbbf24;
      box-shadow: 0 0 8px #fbbf24;
    }
    .status-dot.error {
      background: var(--danger);
      box-shadow: 0 0 8px var(--danger);
    }

    .log {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px 14px;
      max-height: 360px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.6;
    }

    .line {
      margin-bottom: 6px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .line.system {
      color: var(--text-sub);
      font-size: 13px;
    }

    .line.user::before {
      content: "ä½ ï¼š";
      color: var(--accent);
      font-weight: 600;
    }

    .line.bot::before {
      content: "åŠ©æ‰‹ï¼š";
      color: #60a5fa;
      font-weight: 600;
    }

    .controls {
      margin-top: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.18s ease;
      background: transparent;
      color: var(--text-main);
      border: 1px solid var(--border);
    }

    .btn.primary {
      background: var(--accent);
      color: #022c22;
      border-color: transparent;
      box-shadow: 0 12px 25px rgba(34, 197, 94, 0.45);
    }

    .btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 35px rgba(34, 197, 94, 0.55);
    }

    .btn:disabled,
    .btn.disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .mic-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mic-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: none;
      background: radial-gradient(circle at 30% 30%, #4ade80, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      box-shadow: 0 10px 22px rgba(34, 197, 94, 0.55);
      transition: all 0.2s ease;
    }

    .mic-btn.disabled {
      filter: grayscale(0.6);
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .mic-btn .mic-icon {
      width: 22px;
      height: 32px;
      border-radius: 11px;
      border: 2px solid #022c22;
      border-bottom-width: 5px;
      position: relative;
      background: #f9fafb;
    }

    .mic-btn .mic-icon::before {
      /* ä¸ŠåŠéƒ¨åœ†çƒ */
      content: "";
      position: absolute;
      top: 3px;
      left: 4px;
      right: 4px;
      height: 13px;
      border-radius: 999px;
      background: #0f172a;
    }

    .mic-btn .mic-icon::after {
      /* åº•ä¸‹å°ç«–æ† */
      content: "";
      position: absolute;
      bottom: -7px;
      left: 50%;
      width: 12px;
      height: 6px;
      border-radius: 999px;
      transform: translateX(-50%);
      background: #f9fafb;
    }

    .mic-btn.recording {
      background: radial-gradient(circle at 30% 30%, #fb7171, #ef4444);
      box-shadow:
        0 0 0 0 rgba(239, 68, 68, 0.7),
        0 10px 30px rgba(239, 68, 68, 0.7);
      animation: pulse 1.3s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow:
          0 0 0 0 rgba(239, 68, 68, 0.7),
          0 10px 30px rgba(239, 68, 68, 0.7);
      }
      70% {
        box-shadow:
          0 0 0 18px rgba(239, 68, 68, 0),
          0 10px 30px rgba(239, 68, 68, 0.6);
      }
      100% {
        box-shadow:
          0 0 0 0 rgba(239, 68, 68, 0),
          0 10px 30px rgba(239, 68, 68, 0.3);
      }
    }

    .mic-tip {
      font-size: 12px;
      color: var(--text-sub);
      max-width: 260px;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 24px;
      }
      .controls {
        flex-direction: column-reverse;
        align-items: flex-start;
      }
      .mic-container {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>è¯­éŸ³é©±åŠ¨çš„ Google æ—¥ç¨‹åŠ©æ‰‹</h1>

    <div class="card">
      <div class="status-bar">
        <span id="statusDot" class="status-dot"></span>
        <span id="statusText">ç‚¹å‡»ã€Œå¼€å§‹ä¼šè¯ã€è·å–å¼€åœºç™½ï¼Œç„¶åç”¨è¯­éŸ³è·Ÿæˆ‘è¯´ã€‚</span>
      </div>

      <div id="log" class="log"></div>

      <div class="controls">
        <button id="startBtn" class="btn primary">
          â–¶ å¼€å§‹ä¼šè¯
        </button>

        <div class="mic-container">
          <button id="micBtn" class="mic-btn disabled" disabled title="ç‚¹å‡»å¼€å§‹å½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»ç»“æŸ">
            <div class="mic-icon"></div>
          </button>
          <div class="mic-tip">
            ç‚¹å‡»ç»¿è‰²éº¦å…‹é£å¼€å§‹å½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»ç»“æŸå¹¶ä¸Šä¼ è¯†åˆ«ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById("log");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const startBtn = document.getElementById("startBtn");
    const micBtn = document.getElementById("micBtn");

    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let hasStartedConversation = false;
    let micStream = null;

    function appendLine(text, type = "system") {
      const div = document.createElement("div");
      div.className = `line ${type}`;
      div.textContent = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(text, mode = "idle") {
      statusText.textContent = text;
      statusDot.classList.remove("busy", "error");
      if (mode === "busy") statusDot.classList.add("busy");
      if (mode === "error") statusDot.classList.add("error");
    }

    function speak(text) {
      if (!("speechSynthesis" in window)) {
        console.warn("æµè§ˆå™¨ä¸æ”¯æŒ speechSynthesisï¼Œè·³è¿‡è¯­éŸ³æ’­æŠ¥");
        return;
      }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-CN";
      u.rate = 1.05;
      window.speechSynthesis.speak(u);
    }

    async function startConversation() {
      if (hasStartedConversation) {
        // é‡æ–°å¼€å§‹æ–°ä¼šè¯ï¼šæ¸…ç©ºå†å²
        logEl.innerHTML = "";
      }
      hasStartedConversation = true;

      appendLine("=== ä¼šè¯å¼€å§‹ ===", "system");
      setStatus("æ­£åœ¨è·å–å¼€åœºç™½...", "busy");

      try {
        const res = await fetch("/api/start", { method: "POST" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const text =
          data.text ||
          data.message ||
          data.bot ||
          "æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„æ—¥ç¨‹åŠ©æ‰‹ï¼Œä½ æƒ³è®°å½•ä»€ä¹ˆæ—¥ç¨‹ï¼Ÿ";

        appendLine(text, "bot");
        speak(text);
        setStatus("å·²å‡†å¤‡å°±ç»ªï¼šç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³ï¼Œå†ç‚¹ä¸€æ¬¡ç»“æŸã€‚", "idle");

        // æ¿€æ´»éº¦å…‹é£æŒ‰é’®
        micBtn.disabled = false;
        micBtn.classList.remove("disabled");
      } catch (err) {
        console.error(err);
        appendLine("è·å–å¼€åœºç™½å¤±è´¥ï¼š" + err.message, "system");
        setStatus("å¼€åœºç™½è·å–å¤±è´¥ï¼Œä½†ä½ ä»ç„¶å¯ä»¥ç›´æ¥ç‚¹éº¦å…‹é£å½•éŸ³ã€‚", "error");
        micBtn.disabled = false;
        micBtn.classList.remove("disabled");
      }
    }

    async function ensureMicStream() {
      if (micStream) return micStream;
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        return micStream;
      } catch (err) {
        console.error(err);
        appendLine("è·å–éº¦å…‹é£æƒé™å¤±è´¥ï¼š" + err.message, "system");
        setStatus("éº¦å…‹é£ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚", "error");
        throw err;
      }
    }

    async function startRecording() {
      await ensureMicStream();
      audioChunks = [];
      const options = MediaRecorder.isTypeSupported("audio/webm")
        ? { mimeType: "audio/webm" }
        : undefined;

      mediaRecorder = new MediaRecorder(micStream, options);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        await sendAudioToBackend(blob);
      };

      mediaRecorder.start();
      isRecording = true;
      micBtn.classList.add("recording");
      setStatus("æ­£åœ¨å½•éŸ³ä¸­ï¼Œå†æ¬¡ç‚¹å‡»éº¦å…‹é£ç»“æŸå½•éŸ³ã€‚", "busy");
      appendLine("ğŸ™ï¸ æ­£åœ¨å½•éŸ³ï¼Œè¯·å¼€å§‹è¯´è¯â€¦", "system");
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
      }
      isRecording = false;
      micBtn.classList.remove("recording");
      setStatus("å½•éŸ³ç»“æŸï¼Œæ­£åœ¨ä¸Šä¼ å¹¶è¯†åˆ«â€¦", "busy");
    }

    async function sendAudioToBackend(blob) {
      appendLine("â« å·²ä¸Šä¼ ä¸€æ®µè¯­éŸ³ï¼Œç­‰å¾…è¯†åˆ«...", "system");
      const formData = new FormData();
      // è¿™é‡Œå­—æ®µåç”¨ "file"ï¼›å¦‚æœä½ åç«¯å‚æ•°å« "audio" å°±æ”¹æˆ "audio"
      formData.append("file", blob, "speech.webm");

      try {
        const res = await fetch("/api/speech", {
          method: "POST",
          body: formData,
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const userText =
          data.user_text ||
          data.recognized_text ||
          data.transcript ||
          "ï¼ˆè¯­éŸ³å†…å®¹ï¼‰";

        const reply =
          data.assistant_reply ||
          data.reply ||
          data.message ||
          "æˆ‘è¿™è¾¹æ²¡æœ‰æ‹¿åˆ°å›å¤ï¼Œè¯·ç¨åå†è¯•ä¸€æ¬¡ã€‚";

        appendLine(userText, "user");
        appendLine(reply, "bot");
        speak(reply);
        setStatus("å¯ä»¥ç»§ç»­è¯´ä¸‹ä¸€å¥ï¼Œæˆ–å…³é—­é¡µé¢ç»“æŸå¯¹è¯ã€‚", "idle");
      } catch (err) {
        console.error(err);
        appendLine("è¯­éŸ³è¯†åˆ«æˆ–æ—¥ç¨‹åˆ›å»ºå¤±è´¥ï¼š" + err.message, "system");
        setStatus("å‡ºé”™äº†ï¼Œå¯ä»¥ç¨åå†ç‚¹éº¦å…‹é£é‡è¯•ã€‚", "error");
      }
    }

    startBtn.addEventListener("click", () => {
      startConversation();
    });

    micBtn.addEventListener("click", async () => {
      if (micBtn.disabled) return;
      if (!isRecording) {
        await startRecording();
      } else {
        stopRecording();
      }
    });
  </script>
</body>
</html>
